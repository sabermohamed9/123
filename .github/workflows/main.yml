name: KALI-ULTRA-EXIT-NODE

on: 
  workflow_dispatch:

jobs:
  kali_beast:
    runs-on: ubuntu-latest
    steps:
    - name: تفعيل الذاكرة القصوى (تجاوز خطأ Text file busy)
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo fallocate -l 10G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: إعداد الشبكة للـ Exit Node (Forwarding)
      run: |
        echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
        echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p

    - name: تنصيب محرك كالي الشامل (Everything)
      run: |
        wget -q -O - https://archive.kali.org/archive-key.asc | sudo apt-key add -
        echo "deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" | sudo tee /etc/apt/sources.list
        sudo apt-get update
        sudo apt-get install -y kali-desktop-xfce xorg xrdp kali-linux-everything

    - name: ربط Tailscale كـ Exit Node
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --advertise-exit-node --force-reauth

    - name: إعداد مستخدم القناص (Sniper)
      run: |
        sudo adduser sniper --gecos "" --disabled-password
        echo "sniper:KALI_SNIPER_2026" | sudo chpasswd
        sudo adduser sniper sudo
        echo "startxfce4" > /home/sniper/.xsession
        sudo chown sniper:sniper /home/sniper/.xsession
        sudo /etc/init.d/xrdp start

    - name: البقاء في الميدان (12 ساعة)
      run: sleep 43200
      
